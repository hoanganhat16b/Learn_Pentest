# PASS THE HASH
Phương pháp khai thác Pass the Hash (PTH) là một kỹ thuật tấn công mạng được sử dụng để tấn công vào các hệ thống đăng nhập bằng tài khoản và mật khẩu bằng cách sử dụng băm mật khẩu (hash) đã bị đánh cắp thay vì sử dụng mật khẩu thực tế. Kỹ thuật này được sử dụng bởi các hacker để truy cập vào các hệ thống mà họ không có quyền truy cập.

Khi một tài khoản đăng nhập vào hệ thống, mật khẩu được nhập vào và được chuyển đổi sang dạng băm (hash) và được lưu trữ trong bộ nhớ của hệ thống. Khi tài khoản đăng nhập lại, mật khẩu được nhập vào lại và so sánh với băm mật khẩu được lưu trữ. Nếu băm mật khẩu nhập vào giống với băm mật khẩu lưu trữ, hệ thống cho phép tài khoản đăng nhập.

Trong kỹ thuật PTH, kẻ tấn công sẽ đánh cắp băm mật khẩu của một tài khoản đã đăng nhập thành công trên hệ thống. Khi băm mật khẩu này đã bị đánh cắp, kẻ tấn công có thể sử dụng nó để đăng nhập vào hệ thống bằng cách truyền băm mật khẩu này thay vì mật khẩu thực tế. Như vậy, kẻ tấn công không cần phải biết mật khẩu thực tế của tài khoản mà chỉ cần sử dụng băm mật khẩu đã đánh cắp để đăng nhập.

Các bước để thực hiện kỹ thuật PTH như sau:
1. Kẻ tấn công sử dụng các công cụ tấn công để đánh cắp băm mật khẩu của một tài khoản đăng nhập thành công trên hệ thống.
2. Kẻ tấn công sử dụng băm mật khẩu đã đánh cắp để đăng nhập vào hệ thống bằng cách sử dụng các công cụ đăng nhập từ xa như Remote Desktop Protocol (RDP) hoặc Windows Remote Management (WinRM).
3. Khi đăng nhập thành công, kẻ tấn công có thể thực hiện các hành động không mong muốn trên hệ thống, như lấy thông tin, thay đổi dữ liệu hoặc tạo tài khoản mới trên hệ thống.

Pass The Hash (PTH) có tác động đến mức Microsoft đã phải có những chỉnh sửa lớn về việc lưu trữ thông tin đăng nhập và sử dụng chúng để xác thực.

## Giới thiệu về Hashing và NTLM

### Hash

Hash (hàm băm) là một thuật toán lấy một khối dữ liệu tùy ý và trả về chuỗi bit có kích thước cố định. Phần kết quả trả về được gọi là giá trị băm, sao cho thay đổi dữ liệu sẽ thay đổi giá trị băm. Nói cách khác, điều này có nghĩa là bạn lấy một khối văn bản trong trường hợp cụ thể và chạy nó thông qua một số hàm ma thuật và nếu bạn thực hiện một thay đổi nhỏ trong mật khẩu, bạn sẽ kết thúc với một giá trị hoàn toàn khác. 

### NTLM Protocol

Nói qua một chút về NTLM Protocol. Đây là loại giao thức xác thực được sử dụng trong môi trường Microsoft. Cụ thể, nó cho phép người dùng chứng minh danh tính của họ với một server để sử dụng một dịch vụ được yêu cầu bởi server đó.

{% hint style="warning" %}
Note: Trong chủ đề này, từ "server" được dùng theo dạng nghĩa client/server hoặc cũng có thể là workstation. 
{% endhint %}

<img src="../image/NTLM_Basic.png">

Có 2 trường hợp có thể xảy ra
* Người dùng sử dụng thông tin đăng nhập của tài khoản nội bộ của máy chủ. Lúc này máy bủ có thông tin bí mật cảu người dùng và sẽ xác thực người dùng này.
* Trong môi trường Active Directory, người dùng sử dụng tài khoản domain trong quá trình xác thức. Trong trường hợp này máy chủ sẽ yêu cầu bộ điều khiển miền xác minh thông tin do người dùng cung cấp

Quá trình xác thực này sử dụng giao thức NTLMv2 để và hash NTLMv2 sử dụng NTLM hash trong phương thức trao đổi khóa Challenge/Response. Tính năng này cho phép kẻ tấn công xác thực thông qua NTLM hash mà không cần đến mật khẩu hoặc dùng kỹ thuật MITM để đánh cắp trực tiếp NTLMv2 hash để xác thực. Vì lí do này mà nó mang tên là Pass the hash.

PTH có 2 bước chính
* Trích xuất NTLM hash trên máy tính đã chiếm được quyền.
* Sử dụng NTLM hash đã trích xuất được để xác thực tới máy tính khác.

## Trích xuất NTLM Hash

NTLM Hash được lưu trữ rất nhiều nơi trong Windows. Dưới đây là một số phương pháp trích xuất NTLM hash trên Windows từ các vị trí khác nhau.

1. **Security Account Manager (SAM)**

Cơ sở dữ liệu SAM là một tệp Registry lưu trữ các hash NTLM của các tài khoản nội bộ trên máy tính (local account/Microsoft account) và không bao gồm các tài khoản trong domain. SAM được lưu trữ dưới dạng mã hoá tại đường dẫn `%SystemRoot%/system32/config/SAM` và được gán vào khóa registry HKLM/SAM. Các thông tin để giải mã SAM đều có thể tìm thấy trên máy tính. Do đó, khi chiếm được máy tính và có quyền administrator, kẻ tấn công có thể trích xuất tất cả các hash NTLM được lưu trữ trong SAM.

2. **LSASS Memory**

Tiến trình Local Security Authority Subsystem Service (LSASS) cũng có thể chứa NTLM hash. Tệp thực thi của LSASS được lưu tại %SystemRoot%\System32\Lsass.exe và thực thi bởi wininit.exe khi hệ thống khởi động. Mỗi khi người dùng đăng nhập vào hệ thống, cấu trúc dữ liệu gồm tên và NTLM hash được tạo ra và lưu trữ trên vùng nhớ của tiến trình Lsass. Các tài khoản lưu trữ trên bộ nhớ của Lsass bao gồm cả tài khoản nội bộ, tài khoản microsoft và tài khoản domain. Các phiên đang sử dụng trên hệ thống như các tài khoản dịch vụ, phiên RDP, quá trình thực thi bằng tham số RunAs đều được lưu trữ trên tiến trình lsass và được xóa ngay khi người dùng đăng xuất (log off/sign out) khỏi hệ thống.

3. **DCSync và NTDS**

Khi chiếm được của tài khoản admin trên domain controller và muốn trích xuất ntlm hash của các tài khoản khác trong domain, kẻ tấn công có thể lợi dụng giao thức Directory Replication Service Remote (MS-DRSR) để mô phỏng lại hành vi của domain và trích xuất các thông tin của tài khoản mục tiêu, trong đó bao gồm cả NTLM hash.

Ngoài ra, khi truy cập được domain controller, kẻ tấn công có thể đọc được nội dung trên cơ sở dữ liệu của Active directory. Cơ sở dữ liệu này (mặc định) được lưu tại đường dẫn %SystemRoot%\NTDS\Ntds.dit. Sau khi đọc được nội dung, kẻ tấn công có thể sử dụng các công cụ để trích xuất NTLM hash từ cơ sở dữ liệu này.

## PTH Attack

Tấn công Pass the Hash có thể hoạt động trên một lượng lớn kịch bản và công nghệ.Đầu tiên, chúng ta sẽ thảo luận về các cuộc tấn công PTH trên các giao thức và công nghệ nổi tiếng rồi sau đó chúng ta sẽ tóm tắt thông tin về các công cụ khác nhau giúp ích cho việc triển khai PTH.

Ở đây chũng ta sẽ tấn công vượt qua một số giao thức như SMB,PsExec,WMI,RPC,RDP. Và công cụ hỗ trợ tốt nhất cho việc này là `Mimikatz`. Nó là công cụ tối ưu để khám phá hết toàn bộ Windows Security.

Phần này sẽ được trình bày chi tiết trong tài liệu dưới đây.

[Pass the Hass - Hacking Articles](https://github.com/hoanganhat16b/Pentest/blob/API/Windows/Pass_The_Hash.md)

Tham khảo thêm về Pass The Hash

[Pass The Hash - Hackndo](https://en.hackndo.com/pass-the-hash/#ntlm-protocol)

