# Linux Privilege Escalation #1 #

## Question ##

> Tại sao anh lại biết lệnh bash có lỗi để anh leo quyền luôn ạ? 

Cho em hỏi, tại sao khi anh tìm kiếm với lệnh find / -perm -u=s -type f 2>/dev/null thì ra rất nhiều file, sao anh biết được /bin/bash bị lỗi mà anh lợi dụng luôn lệnh bash để nâng quyền ạ ? và lỗi ở đây là lỗi gì ạ ? Vì thực tế em nghĩ rất khó để leo quyền nếu không tìm được gốc rễ của vấn đề.

## Phân tích

Để làm rõ case này, chúng ta sẽ làm rõ một vài vấn đề
* SUID
* Lệnh find
* Privilege Escaltion Lab

### SUID

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.001.png">

Bình thường đối với một file/thư mục sẽ có 3 quyền là r(read), w(write), x(execute).Tuy nhiên ta vẫn sẽ bắt gặp trong hệ thống linux các file có phân quyền không giống như trên

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.002.png">

Điểm khác lạ ở đây chính là sự xuất hiện của phân quyền “s” trong phân quyền của owner. Vậy phân quyền “s” đấy là gì ?

> Phân quyền “s” trong phần phân quyền của owner được gọi là SUID (Set User ID).Phân quyền “s” sẽ thay thế vị trí của phân quyền “x”. Nó cho phép khi file được thực thi bởi một user account nào đó thì file đó sẽ được thực thi dưới quyền của người chủ file.Và nếu chủ file là root , attacker sẽ lạm dụng điều này cho mục đích nâng cấp lên đặc quyền.

Vậy câu lệnh nào sẽ giúp ta tìm kiếm file có phân quyền “s” trong hệ thống một cách dễ dàng và hiệu quả?

### Lệnh find

Find là một câu lệnh mạnh mẽ dùng để tìm kiếm dữ liệu trong Linux. Cú pháp cơ bản của câu lệnh find như sau:

`find [where to start searching from] [expression determines what to find] [-options] [what to find]`

Ví dụ cụ thể

`find /tmp`

Khi không có nội dung cần tìm, lệnh find sẽ tự động liệt kê toàn bộ file chứa bên trong /tmp và chứa cả bên trong những directories con của /tmp

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.003.png">

`find /tmp -group root`

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.004.png">

Lệnh này tìm tất cả các file có phân quyền SUID. Trong đó:
* / : Bắt đầu từ root directory là file có vị trí cao nhất trong sơ đồ cấu trúc file của hệ thống Linux
* -perm: Tìm những file thỏa mãn phân quyền theo sau
* -u=s: Tìm những file binary thuộc sở hữu của root nhưng có phân quyền SUID
* -type: Dạng file cần tìm
* f : Dạng file bình thường, không phải directory hay các file đặc biệt ví dụ như symbolic link, v.v.
* 2>/dev/null: Chuyển tất cả những cảnh báo lỗi hoặc output lỗi vào /dev/null

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.007.png">

### Linux Privilege Escalation Lab

Chúng ta sẽ đi luôn trực tiếp vào phần leo thang.
Sau khi vào hệ thống thành công, kiểm tra có quyền sudo rights hay không

`sudo -l`

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.008.png">

Theo kết quả trên chúng ta bị hỏi password của account www-data khi dùng lệnh sudo. Thử các password như admin, password, root… đều không được nên không thể leo thang dựa vào sudo rights.

Triển khai tìm những phần mềm có thể chạy với SUID:

`find / -perm -u=s -type f 2>/dev/null`

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.009.png">

Sau khi chạy lệnh, chúng ta được danh sách các file thực thi có SUID. Trong đó, chúng ta chú ý phần Python thì nếu Python có SUID, chúng ta có thể lợi dụng Python để leo thang đặc quyền.

Kiểm tra lại 1 lần nữa

`ls -l /usr/bin/python`

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.010.png">

Ta thấy file này vừa có SUID vừa có SGID (tương tự như SUID nhưng là với nhóm).Điều này đồng nghĩa với việc nếu có bất kì user nào chạy câu lệnh Python, Python sẽ luôn được thực thi với quyền root

Để leo thang đặc quyền với Python ta làm như sau

B1: Truy cập trang [](https://gtfobins.github.io/)

Đây là trang cung cấp các thủ thuật lợi dụng các phần mềm được cấp sudo rights hoặc SUID để privilege escalation.

B2: Gõ Python trong thanh tìm kiếm

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.011.png">

B3: Trong phần kết quả trả về chọn SUID và làm theo hướng dẫn

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.012.png">

B4: Tiến hành 

<img src="../../image/Aspose.Words.9d0b263c-30ff-47de-8084-27afffa6db2a.013.png">

